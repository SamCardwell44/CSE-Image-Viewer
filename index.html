<script>
    let imageData = [];
    let selectedTags = [];
    let allTags = [];
    let tagCounts = [];

    let currentPage = 1;
    const imagesPerPage = 50;

    const mainCategories = [
        "houses and buildings", "damp & condensation",
        "energy supply", "energy use",  "heating-systems", 
        "insulation", "person"
    ];

    async function loadImageData() {
        try {
            showLoading(true);
            const response = await fetch('data.csv');
            const csvText = await response.text();
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());

            imageData = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const values = parseCSVLine(line);
                if (values.length >= 5) {
                    const tags = values[2] ? values[2].split(',').map(tag => tag.trim()).filter(tag => tag && tag !== 'NA') : [];
                    imageData.push({
                        filename: values[0],
                        image_path: values[1],
                        tags: tags,
                        thumbnail_path: values[3],
                        original_filepath: values[4] || values[1]
                    });
                }
            }

            showLoading(false);
            processImageData();
            renderCategories();
            renderTags();
            renderImages();
            updateResultsInfo();

        } catch (error) {
            console.error('Error loading CSV data:', error);
            showError('Failed to load image data. Please check that data.csv exists in your repository.');
            showLoading(false);
        }
    }

    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }

        result.push(current.trim());
        return result;
    }

    function showLoading(show) {
        let loader = document.getElementById('loader');
        if (show) {
            if (!loader) {
                loader = document.createElement('div');
                loader.id = 'loader';
                loader.innerHTML = `
                    <div style="text-align: center; padding: 60px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <div style="font-size: 2em; margin-bottom: 20px;">üìö</div>
                        <h3 style="color: #1C0533; margin-bottom: 15px;">Loading Image Data...</h3>
                        <p style="color: #666;">Please wait while we fetch your image collection</p>
                    </div>
                `;
                document.getElementById('imagesGrid').appendChild(loader);
            }
        } else {
            if (loader) loader.remove();
        }
    }

    function showError(message) {
        const container = document.getElementById('imagesGrid');
        container.innerHTML = `
            <div style="text-align: center; padding: 60px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; margin-bottom: 20px;">‚ö†Ô∏è</div>
                <h3 style="color: #1C0533; margin-bottom: 15px;">Error Loading Data</h3>
                <p style="color: #666;">${message}</p>
            </div>
        `;
    }

    async function copyToClipboard(text, element) {
        try {
            await navigator.clipboard.writeText(text);
            const indicator = element.querySelector('.copy-indicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        } catch (err) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);

            const indicator = element.querySelector('.copy-indicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }
    }

    function init() {
        document.getElementById('searchBox').addEventListener('input', handleSearch);
        loadImageData();
    }

    function processImageData() {
        tagCounts = {};
        imageData.forEach(image => {
            image.tags.forEach(tag => {
                if (tag && tag !== 'NA') {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                }
            });
        });
        allTags = Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]);
    }

    function getDynamicTagCounts() {
        const currentFilteredImages = getFilteredImages();
        const dynamicCounts = {};
        allTags.forEach(tag => {
            if (!selectedTags.includes(tag)) {
                dynamicCounts[tag] = currentFilteredImages.filter(image => image.tags.includes(tag)).length;
            }
        });
        return dynamicCounts;
    }

    function handleSearch() {
        const searchTerm = document.getElementById('searchBox').value.toLowerCase();
        renderCategories(searchTerm);
        renderTags(searchTerm);
    }

    function renderCategories(searchTerm = '') {
        const container = document.getElementById('categoriesContainer');
        const dynamicCounts = getDynamicTagCounts();
        let filteredCategories = mainCategories.filter(category => 
            category.toLowerCase().includes(searchTerm) && !selectedTags.includes(category)
        );
        filteredCategories.sort((a, b) => (dynamicCounts[b] || 0) - (dynamicCounts[a] || 0));

        container.innerHTML = filteredCategories.map(category => {
            const count = dynamicCounts[category] || 0;
            return `<span class="category-tag ${count === 0 ? 'disabled' : ''}" onclick="toggleTag('${category}')">${category} (${count})</span>`;
        }).join('');
    }

    function renderTags(searchTerm = '') {
        const container = document.getElementById('tagsContainer');
        const dynamicCounts = getDynamicTagCounts();
        let filteredTags = allTags.filter(tag => 
            tag.toLowerCase().includes(searchTerm) && 
            !selectedTags.includes(tag) &&
            !mainCategories.includes(tag.toLowerCase())
        );
        filteredTags.sort((a, b) => (dynamicCounts[b] || 0) - (dynamicCounts[a] || 0));

        container.innerHTML = filteredTags.map(tag => {
            const count = dynamicCounts[tag] || 0;
            return `<span class="tag ${count === 0 ? 'disabled' : ''}" onclick="toggleTag('${tag}')">${tag} (${count})</span>`;
        }).join('');
    }

    function renderSelectedTags() {
        const container = document.getElementById('selectedTags');
        const selectedContainer = document.getElementById('selectedTagsContainer');
        if (selectedTags.length === 0) {
            selectedContainer.style.display = 'none';
            return;
        }

        selectedContainer.style.display = 'block';
        container.innerHTML = selectedTags.map(tag => {
            const isCategory = mainCategories.includes(tag.toLowerCase());
            const className = isCategory ? 'category-tag selected' : 'tag selected';
            return `<span class="${className}" onclick="toggleTag('${tag}')">${tag} ‚úï</span>`;
        }).join('');
    }

    function toggleTag(tag) {
        const index = selectedTags.indexOf(tag);
        if (index === -1) {
            selectedTags.push(tag);
        } else {
            selectedTags.splice(index, 1);
        }
        currentPage = 1; // Reset to page 1 on filter change
        renderCategories(document.getElementById('searchBox').value.toLowerCase());
        renderTags(document.getElementById('searchBox').value.toLowerCase());
        renderSelectedTags();
        renderImages();
        updateResultsInfo();
    }

    function clearAllTags() {
        selectedTags = [];
        currentPage = 1;
        renderCategories(document.getElementById('searchBox').value.toLowerCase());
        renderTags(document.getElementById('searchBox').value.toLowerCase());
        renderSelectedTags();
        renderImages();
        updateResultsInfo();
    }

    function getFilteredImages() {
        if (selectedTags.length === 0) return imageData;
        return imageData.filter(image =>
            selectedTags.every(selectedTag => image.tags.includes(selectedTag))
        );
    }

    function renderImages() {
        const filteredImages = getFilteredImages();
        const paginatedImages = filteredImages.slice((currentPage - 1) * imagesPerPage, currentPage * imagesPerPage);
        const container = document.getElementById('imagesGrid');
        const noResults = document.getElementById('noResults');
        const infoBox = document.getElementById('resultsInfo');

        if (filteredImages.length === 0) {
            container.style.display = 'none';
            noResults.style.display = 'block';
            infoBox.innerHTML = '';
            return;
        }

        container.style.display = 'grid';
        noResults.style.display = 'none';

        container.innerHTML = paginatedImages.map(image => `
            <div class="image-card" onclick="copyToClipboard('${image.original_filepath}', this)">
                <div class="copy-indicator">Copied to clipboard!</div>
                <img src="${image.thumbnail_path}" alt="${image.filename}" loading="lazy">
                <div class="image-info">
                    <div class="image-filename">${image.filename}</div>
                    <div class="image-tags">
                        ${image.tags.filter(tag => tag !== 'NA').map(tag => 
                            `<span class="image-tag">${tag}</span>`
                        ).join('')}
                    </div>
                </div>
            </div>
        `).join('');

        updateResultsInfo(filteredImages.length);
        renderPaginationControls(filteredImages.length);
    }

    function updateResultsInfo(total = null) {
        const infoBox = document.getElementById('resultsInfo');
        const filtered = total ?? getFilteredImages().length;
        infoBox.innerHTML = `${filtered} image${filtered !== 1 ? 's' : ''} found`;
    }

    function renderPaginationControls(totalImages) {
        const container = document.getElementById('resultsInfo');
        const totalPages = Math.ceil(totalImages / imagesPerPage);
        if (totalPages <= 1) return;

        let paginationHTML = `<div style="margin-top:10px;">Page: `;
        for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `<button onclick="goToPage(${i})" style="margin:0 5px; ${i === currentPage ? 'font-weight:bold;' : ''}">${i}</button>`;
        }
        paginationHTML += `</div>`;
        container.innerHTML += paginationHTML;
    }

    function goToPage(page) {
        currentPage = page;
        renderImages();
    }

    window.onload = init;
</script>
